<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!---引入chatroom样式文件---->
    <link rel="stylesheet" href="//player.polyv.net/jssdk/polyv-chatroom.min.css"/>
    <script src="//s1.videocc.net/library/jquery/3.x/jquery-3.5.1.min.js"></script>
    <script src="//s1.videocc.net/library/blueimp-md5/md5-2.18.0.min.js"></script>
    <!---引入直播sdk---->
    <script src="//player.polyv.net/livesdk/polyv-live.min.js"></script>
    <!---引入chatroom sdk---->
    <script src="//player.polyv.net/jssdk/polyv-chatroom.min.js"></script>
    <title>快速集成三分屏</title>
    <style>
      .clearfix:before, .clearfix:after {
        content: " ";
        display: table;
      }
      .clearfix:after {
        clear: both;
      }
      .sdk-wrap-left {
        float: left;
        width: 400px;
      }
      .mainScreen,.subScreen{
        width: 100%;
        height: 300px;
      }
      .chatroom{
        float: left;
        width:300px;
        height: 300px;
      }
    </style>
  </head>
  <body style="width: 950px;">
    <div class="sdk-wrap clearfix">
      <div class="sdk-wrap-left">
        <div id="ppt" class="mainScreen"></div>
        <div id="player" class="subScreen"></div>
      </div>
      <div id="wrap" class="chatroom"></div>
    </div>
    <script>
      var chatroom = null;
      var liveSdk = null;
      window.onload = function () {
        // 注意事项：appSecret，appId不建议在前端显示，不安全，请您一定要请求后端接口获取sign
        //参数开始
        var appSecret = "";
        var appId = "";
        var channelId = "";
        //参数结束
        var userId = "test-001";
        var userName = '测试-001';
        var userPic = 'http://livestatic.videocc.net/assets/wimages/missing_face.png';
        var chatData = getChatToken(); //从接口获取聊天室信息
        //第一步：初始化聊天室
        chatroom = new PolyvChatRoom({
          roomId: channelId,
          userId: userId,
          nick: userName,
          pic: userPic,
          token: chatData.token,
          mediaChannelKey: chatData.mediaChannelKey,
          version: "2.0",
          container: "#wrap",
          width: 300,
          height: 600,
          userType: "slice",
          roomMessage: function (data) {
            // data为聊天室socket消息，当有聊天室消息时会触发此方法
            console.log(data);
          },
        });
        var params = {
          appId: appId,
          channelId: channelId,
          timestamp: new Date().getTime(),
        };
        var sign = getSign(params);
        //第二步：初始化直播sdk对象
        var liveSdk = new PolyvLiveSdk({
          channelId: channelId,
          sign: sign, // 频道验证签名
          timestamp: params.timestamp, // 毫秒级时间戳
          appId: appId, // polyv 后台的appId
          socket: chatroom.chat.socket,
          user: {
            userId: userId,
            userName: userName,
            pic: userPic,
          },
        });

        // 监听频道信息并初始化播放器
        liveSdk.on(PolyvLiveSdk.EVENTS.CHANNEL_DATA_INIT, (event, data) => {
          //第三步：设置直播播放器
          liveSdk.setupPlayer({
            pptEl: "#ppt",
            el: "#player",
            type: "auto",
            controllerPosition: "ppt",
            pptNavBottom: "80px",
            autoplay: true,
          });
        });
        /*********函数***********/
        //签名
        function getSign(params) {
          var paramsStr = "";
          $.each(params, function (key, val) {
            paramsStr += key + "" + val;
          });
          var finalStr = appSecret + paramsStr + appSecret;
          return md5(finalStr).toUpperCase();
        }
        // 获取聊天室token
        function getChatToken() {
          var chatData = {};
          var apiUrl = "https://api.polyv.net/live/v3/channel/common/get-chat-token";
          var params = {
            appId: appId, // 账号appId
            channelId: channelId, // 频道号
            role: "viewer", // 角色,viewer：观看者
            timestamp: new Date().getTime(),
            userId: userId, // 观看者用户Id
          };
          params.sign = getSign(params);
          $.ajax({
            url: apiUrl,
            type: "POST",
            async: false,
            data: params,
            success: (data) => {
              chatData = data.data;
            },
          });
          return chatData;
        }
      };
    </script>
  </body>
</html>
